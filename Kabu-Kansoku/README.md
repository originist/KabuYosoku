# Kabu‑Kansoku

Kabu‑Kansoku は日本株のストップ高／ストップ安（値幅制限到達）を観測するためのデスクトップアプリケーションです。立花証券 e 支店 API から株価を取得し、監視対象銘柄がその日の制限値幅に到達したかどうかを判定してダッシュボード形式で表示します。本アプリケーションは「観測」に特化しており、売買機能は実装されていません。

## 特長

- **ウォッチリスト**: 監視したい銘柄コードを追加・削除・並び替えできます。
- **リアルタイム監視**: アプリ起動中、設定した間隔で株価を取得し、ストップ高／安到達を検知します。
- **制限値幅計算**: アプリ内に値幅制限テーブルを内蔵し、基準値段から当日のストップ高・ストップ安を算出します。
- **判定結果**:
  - **到達**: 当日中に一度でも制限値段に一致したかどうか（場中は現在値ベース、引け後は日足ベースで確定）。
  - **引け**: 終値が制限値段と一致したかどうか。
  - **連続**: 日次確定結果から連続日数を計算して表示します。
- **ローカル保存**: SQLite データベースに日次結果とストップ到達イベントのみ保存します（ティックデータ全量は保存しません）。
- **データソースの切替**: API を呼び出さない `DummyDataSource` と、立花証券 API を利用する `TachibanaDataSource` の 2 種類を実装。設定タブで切り替えができます。
- **ダッシュボード風 UI**: 左側に銘柄一覧テーブル、右側に選択銘柄の詳細（当日のイベントログや履歴サマリ）を表示します。履歴タブでは過去の判定結果と連続日数を閲覧できます。

## インストール

### 前提条件

- Python 3.11 以上
- PySide6 はサイズが大きいためビルドツールが必要な場合があります（Windows では Visual C++ build tools、macOS では Xcode Command Line Tools）。

依存ライブラリをインストールします:

```sh
pip install -r requirements.txt
```

## 実行方法

開発時には `src/` 直下からアプリケーションを起動できます:

```sh
python src/main.py
```

デフォルトではダミーデータソース (`DummyDataSource`) が使用され、疑似的な株価が表示されます。実際の立花証券 API を利用する場合は、環境変数または OS のキーリングに認証情報を設定し、設定タブで `TachibanaDataSource` を選択してください。

### 立花証券 API 用の環境変数

`TachibanaDataSource` は、以下の環境変数またはキーリングから認証情報を取得します（必要な項目はご利用の API 契約により異なります）。

- `TACHIBANA_USER_ID` – ユーザー ID
- `TACHIBANA_PASSWORD` – ログインパスワード
- `TACHIBANA_SECOND_PASSWORD` – 第二暗証番号（必要な場合）
- `TACHIBANA_TEL_PASS` – 電話認証パスコード
- `TACHIBANA_ACCOUNT_CODE` – 口座番号

アプリ起動後初回のログイン時に電話認証を行い、取得した「仮想 URL」を当日中はキャッシュして再利用します。認証情報をリポジトリに含めないよう注意してください。

## スタンドアロン実行ファイルの作成

Windows と macOS 各 OS 上で実行ファイルを生成する PyInstaller 用 spec ファイルが `build/` ディレクトリに用意されています。ビルドは該当 OS 上で実行する必要があります。

### Windows（`dist/Kabu-Kansoku.exe` を生成）

```sh
pip install -r requirements.txt
pyinstaller build/pyinstaller_win.spec
```

### macOS（`dist/Kabu-Kansoku.app` を生成）

```sh
pip install -r requirements.txt
pyinstaller build/pyinstaller_mac.spec
```

## 動作確認の手順

1. ダミーデータソースでアプリを起動し、シミュレーションされた株価が表示されることを確認します。
2. 設定タブから `TachibanaDataSource` に切り替え、環境変数を設定してログインおよび電話認証が成功することを確認します。
3. ウォッチリストに複数の銘柄コードを追加し、それぞれの制限値幅が正しく計算・表示されることを確認します。
4. 市場終了後、履歴タブで日次判定結果と連続日数が記録されていることを確認します。
5. PyInstaller で実行ファイルを生成し、クリーンな環境で起動できることを確認します。

## ライセンス

このプロジェクトは無保証で提供されています。必要に応じてライセンスを追加または変更してください。